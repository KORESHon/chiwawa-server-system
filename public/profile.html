<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль - Chiwawa Server</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'minecraft-dark': '#0a0a0a',
                        'minecraft-darker': '#050505',
                        'minecraft-gold': '#FFAA00',
                        'minecraft-yellow': '#FFFF55',
                        'minecraft-gray': '#2a2a2a',
                        'minecraft-light-gray': '#3a3a3a',
                        'minecraft-lighter-gray': '#404040'
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            }
        }
    </script>
    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #FFAA00 #1a1a1a;
        }
        
        *::-webkit-scrollbar {
            width: 8px;
        }
        
        *::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        *::-webkit-scrollbar-thumb {
            background: #FFAA00;
            border-radius: 4px;
        }
        
        .glass-effect {
            background: rgba(42, 42, 42, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 170, 0, 0.2);
        }
        
        .gold-glow {
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
        }
        
        .minecraft-button {
            background: linear-gradient(135deg, #FFAA00 0%, #FF8800 100%);
            box-shadow: 0 4px 15px rgba(255, 170, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .minecraft-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 170, 0, 0.4);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            min-height: 100vh;
        }
        
        .minecraft-card {
            background: rgba(42, 42, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 170, 0, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body class="text-white min-h-screen overflow-x-hidden">
    <!-- Навигация -->
    <nav class="minecraft-card sticky top-0 z-50 m-4 rounded-xl">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center hover:scale-105 transition-transform duration-200">
                        <i class="fas fa-cubes text-minecraft-gold text-2xl mr-3 floating"></i>
                        <span class="text-2xl font-bold bg-gradient-to-r from-minecraft-gold to-minecraft-yellow bg-clip-text text-transparent">
                            Chiwawa Server
                        </span>
                    </a>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="/" class="text-gray-300 hover:text-minecraft-gold transition-all duration-300 hover:scale-105">
                        <i class="fas fa-home mr-2"></i>Главная
                    </a>
                    <a href="/profile" class="text-minecraft-gold font-medium hover:scale-105 transition-all duration-300">
                        <i class="fas fa-user mr-2"></i>Профиль
                    </a>
                    <a href="/admin" class="text-gray-300 hover:text-minecraft-gold transition-all duration-300 hover:scale-105 hidden" id="admin-link">
                        <i class="fas fa-cog mr-2"></i>Админ панель
                    </a>
                    <button id="logout-btn" class="minecraft-button text-white px-4 py-2 rounded-lg font-medium hover:scale-105 transition-all duration-300">
                        <i class="fas fa-sign-out-alt mr-2"></i>Выйти
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Сообщение для неавторизованных пользователей -->
        <div id="not-authorized-section" class="max-w-md mx-auto fade-in hidden">
            <div class="minecraft-card rounded-xl p-8 text-center">
                <i class="fas fa-lock text-minecraft-gold text-4xl mb-4 floating"></i>
                <h2 class="text-3xl font-bold bg-gradient-to-r from-minecraft-gold to-minecraft-yellow bg-clip-text text-transparent mb-4">
                    Доступ ограничен
                </h2>
                <p class="text-gray-400 mb-6">Для просмотра профиля необходимо войти в систему</p>
                
                <div class="flex gap-3">
                    <a href="/login" class="flex-1 minecraft-button text-white py-3 px-4 rounded-lg text-center font-medium">
                        <i class="fas fa-sign-in-alt mr-2"></i>Войти
                    </a>
                    <a href="/register" class="flex-1 bg-minecraft-gray border border-minecraft-light-gray text-white py-3 px-4 rounded-lg hover:border-minecraft-gold transition-all duration-300 text-center">
                        <i class="fas fa-user-plus mr-2"></i>Регистрация
                    </a>
                </div>
            </div>
        </div>

        <!-- Профиль пользователя (показывается после входа) -->
        <div id="profile-section" class="hidden fade-in">
            <!-- Заголовок профиля -->
            <div class="minecraft-card rounded-xl p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-minecraft-gold to-minecraft-yellow rounded-full flex items-center justify-center mr-6 gold-glow">
                            <i class="fas fa-user text-minecraft-dark text-3xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-minecraft-gold to-minecraft-yellow bg-clip-text text-transparent" id="user-nickname">Loading...</h1>
                            <p class="text-gray-300 text-lg" id="user-trust-level">Загрузка...</p>
                            <div class="flex items-center mt-2">
                                <div class="w-32 bg-minecraft-gray rounded-full h-2 mr-3">
                                    <div id="trust-progress-header" class="bg-gradient-to-r from-minecraft-gold to-minecraft-yellow h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <span class="text-sm text-gray-400" id="trust-progress-text">0/100</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Статус</div>
                        <div id="user-status" class="font-bold text-lg text-green-400">Активен</div>
                        <div class="text-sm text-gray-400 mt-1">Регистрация</div>
                        <div id="user-created" class="text-sm text-gray-300">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Табы -->
            <div class="minecraft-card rounded-xl mb-8">
                <div class="border-b border-minecraft-light-gray">
                    <nav class="flex space-x-8 px-6">
                        <button class="tab-btn py-4 px-2 border-b-2 border-minecraft-gold text-minecraft-gold font-medium transition-all duration-300" data-tab="info">
                            <i class="fas fa-info-circle mr-2"></i>Информация
                        </button>
                        <button class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-minecraft-gold transition-all duration-300" data-tab="settings">
                            <i class="fas fa-cog mr-2"></i>Настройки
                        </button>
                        <button class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-minecraft-gold transition-all duration-300" data-tab="activity">
                            <i class="fas fa-history mr-2"></i>Активность
                        </button>
                        <button class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-minecraft-gold transition-all duration-300" data-tab="stats">
                            <i class="fas fa-chart-bar mr-2"></i>Статистика
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <!-- Вкладка информации -->
                    <div id="tab-info" class="tab-content">
                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Основная информация -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-id-card mr-3"></i>Основная информация
                                </h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-3 border-b border-minecraft-light-gray">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fas fa-gamepad mr-3 text-minecraft-gold"></i>Minecraft ник:
                                        </span>
                                        <span id="profile-nickname" class="font-bold text-white">Loading...</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-minecraft-light-gray">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fas fa-envelope mr-3 text-minecraft-gold"></i>Email:
                                        </span>
                                        <span id="profile-email" class="font-medium text-white">Loading...</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-minecraft-light-gray">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fab fa-discord mr-3 text-minecraft-gold"></i>Discord:
                                        </span>
                                        <span id="profile-discord" class="font-medium text-white">Loading...</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fas fa-calendar mr-3 text-minecraft-gold"></i>Дата регистрации:
                                        </span>
                                        <span id="profile-created" class="font-medium text-white">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Trust Level прогресс -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-star mr-3"></i>Уровень доверия
                                </h3>
                                <div class="space-y-6">
                                    <div class="text-center">
                                        <div class="text-4xl font-bold text-minecraft-gold mb-2" id="trust-current">0</div>
                                        <div class="text-gray-300" id="trust-current-name">Новичок</div>
                                    </div>
                                    
                                    <div class="relative">
                                        <div class="w-full bg-minecraft-gray rounded-full h-4">
                                            <div id="trust-progress" class="bg-gradient-to-r from-minecraft-gold to-minecraft-yellow h-4 rounded-full transition-all duration-500 gold-glow" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between text-sm text-gray-400 mt-2">
                                            <span>Текущий: <span id="trust-reputation" class="text-minecraft-gold font-bold">0</span></span>
                                            <span>До следующего: <span id="trust-next" class="text-minecraft-gold font-bold">10</span></span>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-minecraft-dark rounded-lg p-4">
                                        <div class="text-sm text-gray-400 mb-2">Привилегии уровня:</div>
                                        <div id="trust-privileges" class="text-minecraft-gold text-sm">
                                            Базовые права пользователя
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка настроек -->
                    <div id="tab-settings" class="tab-content hidden">
                        <div class="glass-effect rounded-xl p-6">
                            <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                <i class="fas fa-cog mr-3"></i>Настройки профиля
                            </h3>
                            
                            <div id="settings-message" class="hidden mb-6"></div>
                            
                            <form id="settings-form" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        <i class="fas fa-user mr-2 text-minecraft-gold"></i>Имя
                                    </label>
                                    <input type="text" name="first_name" id="settings-firstname"
                                        class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                        placeholder="Ваше имя (опционально)">
                                </div>
                                
                                <!-- Привязка Discord через OAuth -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        <i class="fab fa-discord mr-2 text-minecraft-gold"></i>Discord аккаунт
                                    </label>
                                    <div id="discord-status" class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white flex items-center justify-between">
                                        <span id="discord-info" class="text-gray-400">Не привязан</span>
                                        <button type="button" id="discord-connect-btn" class="px-4 py-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg text-sm font-medium transition-all duration-300">
                                            <i class="fab fa-discord mr-1"></i>Привязать Discord
                                        </button>
                                    </div>
                                </div>

                                <!-- Подтверждение email -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        <i class="fas fa-envelope mr-2 text-minecraft-gold"></i>Подтверждение Email
                                    </label>
                                    <div class="mb-2 text-sm text-gray-400">
                                        Текущая почта: <span id="current-email" class="text-minecraft-yellow">Загрузка...</span>
                                    </div>
                                    <div id="email-verification-status" class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white flex items-center justify-between">
                                        <span id="email-status" class="text-gray-400">Загрузка...</span>
                                        <div class="flex gap-2">
                                            <button type="button" id="change-email-btn" class="px-4 py-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg text-sm font-medium transition-all duration-300">
                                                <i class="fas fa-edit mr-1"></i>Сменить почту
                                            </button>
                                            <button type="button" id="verify-email-btn" class="hidden px-4 py-1 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white rounded-lg text-sm font-medium transition-all duration-300">
                                                <i class="fas fa-envelope-open mr-1"></i>Подтвердить почту
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="pt-4 border-t border-minecraft-light-gray">
                                    <h4 class="text-lg font-medium text-minecraft-gold mb-4">Смена пароля</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                                <i class="fas fa-lock mr-2 text-minecraft-gold"></i>Текущий пароль
                                            </label>
                                            <input type="password" name="current_password" id="settings-current-password"
                                                class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                                placeholder="Введите текущий пароль для смены">
                                        </div>
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                                    <i class="fas fa-key mr-2 text-minecraft-gold"></i>Новый пароль
                                                </label>
                                                <input type="password" name="new_password" id="settings-new-password"
                                                    class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                                    placeholder="Минимум 6 символов">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                                    <i class="fas fa-check mr-2 text-minecraft-gold"></i>Подтверждение пароля
                                                </label>
                                                <input type="password" name="confirm_password" id="settings-confirm-password"
                                                    class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                                    placeholder="Повторите новый пароль">
                                            </div>
                                        </div>
                                        <div class="bg-minecraft-dark rounded-lg p-4">
                                            <div class="text-sm text-gray-400">
                                                <i class="fas fa-info-circle mr-2 text-minecraft-gold"></i>
                                                Для смены пароля обязательно введите текущий пароль
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-center pt-4">
                                    <button type="submit" class="minecraft-button text-white px-8 py-3 rounded-lg font-medium text-lg">
                                        <i class="fas fa-save mr-2"></i>Сохранить изменения
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Вкладка активности -->
                    <div id="tab-activity" class="tab-content hidden">
                        <div class="glass-effect rounded-xl p-6">
                            <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                <i class="fas fa-history mr-3"></i>История активности
                            </h3>
                            <div id="activity-list" class="space-y-3">
                                <div class="text-center text-gray-400 py-12">
                                    <i class="fas fa-history text-4xl mb-4"></i>
                                    <p class="text-lg">Загрузка активности...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка статистики -->
                    <div id="tab-stats" class="tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="glass-effect rounded-xl p-6 text-center">
                                <i class="fas fa-clock text-minecraft-gold text-3xl mb-3"></i>
                                <div class="text-3xl font-bold text-white mb-2" id="stat-playtime">0</div>
                                <div class="text-gray-400">Часов игры</div>
                            </div>
                            <div class="glass-effect rounded-xl p-6 text-center">
                                <i class="fas fa-sign-in-alt text-minecraft-gold text-3xl mb-3"></i>
                                <div class="text-3xl font-bold text-white mb-2" id="stat-logins">0</div>
                                <div class="text-gray-400">Входов</div>
                            </div>
                            <div class="glass-effect rounded-xl p-6 text-center">
                                <i class="fas fa-exclamation-triangle text-minecraft-gold text-3xl mb-3"></i>
                                <div class="text-3xl font-bold text-white mb-2" id="stat-warnings">0</div>
                                <div class="text-gray-400">Предупреждений</div>
                            </div>
                            <div class="glass-effect rounded-xl p-6 text-center">
                                <i class="fas fa-trophy text-minecraft-gold text-3xl mb-3"></i>
                                <div class="text-3xl font-bold text-white mb-2" id="stat-achievements">0</div>
                                <div class="text-gray-400">Достижений</div>
                            </div>
                        </div>
                        
                        <div class="grid lg:grid-cols-2 gap-8">
                            <div class="glass-effect rounded-xl p-6">
                                <h4 class="text-lg font-bold text-minecraft-gold mb-4 flex items-center">
                                    <i class="fas fa-chart-line mr-3"></i>Активность по дням
                                </h4>
                                <div id="activity-chart" class="text-center text-gray-400 py-8">
                                    График активности будет здесь
                                </div>
                            </div>
                            
                            <div class="glass-effect rounded-xl p-6">
                                <h4 class="text-lg font-bold text-minecraft-gold mb-4 flex items-center">
                                    <i class="fas fa-medal mr-3"></i>Последние достижения
                                </h4>
                                <div id="recent-achievements" class="space-y-3">
                                    <div class="text-center text-gray-400 py-8">
                                        <i class="fas fa-trophy text-2xl mb-2"></i>
                                        <p>Пока нет достижений</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        let currentUser = null;

        // Проверка авторизации при загрузке
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('auth_token');
            if (token) {
                try {
                    const response = await fetch('/api/auth/verify', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        currentUser = userData.user;
                        showProfile();
                        loadProfileData();
                    } else {
                        localStorage.removeItem('auth_token');
                        showNotAuthorized();
                    }
                } catch (error) {
                    console.error('Ошибка проверки токена:', error);
                    showNotAuthorized();
                }
            } else {
                showNotAuthorized();
            }
        });

        // Выход
        document.getElementById('logout-btn').addEventListener('click', async () => {
            const token = localStorage.getItem('auth_token');
            if (token) {
                try {
                    await fetch('/api/auth/logout', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } catch (error) {
                    console.error('Ошибка выхода:', error);
                }
            }
            
            localStorage.removeItem('auth_token');
            localStorage.removeItem('remember_me');
            localStorage.removeItem('token_expires');
            currentUser = null;
            window.location.href = '/login';
        });

        // Переключение вкладок
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                
                // Убираем активность с всех кнопок и контента
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-minecraft-gold', 'text-minecraft-gold');
                    b.classList.add('border-transparent', 'text-gray-400');
                });
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                
                // Активируем текущую вкладку
                btn.classList.remove('border-transparent', 'text-gray-400');
                btn.classList.add('border-minecraft-gold', 'text-minecraft-gold');
                document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                
                // Загружаем данные для вкладки
                if (tabId === 'activity') {
                    loadActivity();
                } else if (tabId === 'stats') {
                    loadStatistics();
                }
            });
        });

        // Обработка настроек
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Проверка смены пароля
            if (data.new_password) {
                if (!data.current_password) {
                    showMessage('settings-message', 'Для смены пароля необходимо указать текущий пароль', 'error');
                    return;
                }
                
                if (data.new_password !== data.confirm_password) {
                    showMessage('settings-message', 'Новые пароли не совпадают', 'error');
                    return;
                }
                
                if (data.new_password.length < 6) {
                    showMessage('settings-message', 'Пароль должен содержать минимум 6 символов', 'error');
                    return;
                }
            }
            
            // Убираем подтверждение пароля из отправляемых данных
            delete data.confirm_password;
            
            // Если пароль не указан, не отправляем поля смены пароля
            if (!data.new_password) {
                delete data.new_password;
                delete data.current_password;
            }
            
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('settings-message', 'Настройки успешно сохранены!', 'success');
                    // Очищаем поля пароля
                    document.getElementById('settings-current-password').value = '';
                    document.getElementById('settings-new-password').value = '';
                    document.getElementById('settings-confirm-password').value = '';
                    // Перезагружаем данные профиля
                    loadProfileData();
                } else {
                    const error = await response.json();
                    showMessage('settings-message', error.error || 'Ошибка сохранения настроек', 'error');
                }
            } catch (error) {
                console.error('Ошибка сохранения настроек:', error);
                showMessage('settings-message', 'Ошибка соединения с сервером', 'error');
            }
        });

        // Обработчики для Discord и email верификации
        document.getElementById('discord-connect-btn').addEventListener('click', function() {
            if (this.textContent.includes('Привязать')) {
                // Переадресация на Discord OAuth
                window.location.href = '/api/auth/discord';
            } else {
                // Отвязка Discord
                if (confirm('Вы уверены, что хотите отвязать Discord аккаунт?')) {
                    // TODO: Реализовать отвязку Discord
                    showMessage('settings-message', 'Отвязка Discord пока не реализована', 'error');
                }
            }
        });

        document.getElementById('verify-email-btn').addEventListener('click', async function() {
            const token = localStorage.getItem('auth_token');
            this.disabled = true;
            this.textContent = 'Отправка...';
            
                try {
                    const response = await fetch('/api/auth/send-verification', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });                if (response.ok) {
                    showMessage('settings-message', 'Письмо с подтверждением отправлено на ваш email', 'success');
                } else {
                    const error = await response.json();
                    showMessage('settings-message', error.error || 'Ошибка отправки письма', 'error');
                }
            } catch (error) {
                showMessage('settings-message', 'Ошибка соединения', 'error');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-envelope-open mr-1"></i>Отправить подтверждение';
            }
        });

        // Обработчик для смены почты
        document.getElementById('change-email-btn').addEventListener('click', function() {
            const newEmail = prompt('Введите новый адрес электронной почты:');
            if (newEmail && newEmail.includes('@')) {
                // Здесь можно добавить API вызов для смены почты
                showMessage('settings-message', 'Функция смены почты будет добавлена в следующем обновлении', 'info');
            } else if (newEmail) {
                showMessage('settings-message', 'Введите корректный email адрес', 'error');
            }
        });

        function showNotAuthorized() {
            document.getElementById('not-authorized-section').classList.remove('hidden');
            document.getElementById('profile-section').classList.add('hidden');
            document.getElementById('logout-btn').style.display = 'none';
            document.getElementById('admin-link').classList.add('hidden');
        }

        function showProfile() {
            document.getElementById('not-authorized-section').classList.add('hidden');
            document.getElementById('profile-section').classList.remove('hidden');
            document.getElementById('logout-btn').style.display = 'block';
        }

        async function loadProfileData() {
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Обновляем основную информацию
                    const displayName = data.minecraft_nick || data.nickname || 'N/A';
                    const firstName = data.first_name;
                    const fullDisplayName = firstName ? `${displayName} (${firstName})` : displayName;
                    
                    document.getElementById('user-nickname').textContent = fullDisplayName;
                    document.getElementById('user-trust-level').textContent = `Ранг: ${data.trust_level || 0} - ${data.trust_level_name || 'Новичок'}`;
                    document.getElementById('profile-nickname').textContent = fullDisplayName;
                    document.getElementById('profile-email').textContent = data.email || 'N/A';
                    document.getElementById('current-email').textContent = data.email || 'Не указан';
                    document.getElementById('profile-discord').textContent = data.discord || 'Не привязан';
                    document.getElementById('profile-created').textContent = new Date(data.registered_at).toLocaleDateString('ru-RU');
                    document.getElementById('user-created').textContent = new Date(data.registered_at).toLocaleDateString('ru-RU');

                    // Trust Level информация
                    document.getElementById('trust-current').textContent = data.trust_level || 0;
                    
                    // Прогресс Trust Level
                    const trustLevel = data.trust_level || 0;
                    const progressPercent = Math.min((trustLevel / 5) * 100, 100);
                    document.getElementById('trust-progress').style.width = progressPercent + '%';
                    document.getElementById('trust-progress-header').style.width = progressPercent + '%';
                    
                    // Для администратора показываем символ бесконечности
                    if (trustLevel >= 5) {
                        document.getElementById('trust-progress-text').innerHTML = '∞';
                    } else {
                        const current = trustLevel * 20; // Условный прогресс
                        const required = (trustLevel + 1) * 20;
                        document.getElementById('trust-progress-text').textContent = `${current}/${required}`;
                    }
                    
                    // Заполняем форму настроек
                    document.getElementById('settings-firstname').value = data.first_name || '';
                    
                    // Статистика репутации
                    document.getElementById('trust-reputation').textContent = trustLevel * 20;
                    if (trustLevel >= 5) {
                        document.getElementById('trust-next').textContent = '∞';
                    } else {
                        document.getElementById('trust-next').textContent = ((trustLevel + 1) * 20) - (trustLevel * 20);
                    }
                    
                    // Привилегии уровня
                    document.getElementById('trust-privileges').textContent = getTrustLevelPrivileges(data.trust_level || 0);
                    
                    // Статистика
                    const stats = data.stats || {};
                    document.getElementById('stat-playtime').textContent = Math.floor((stats.playtime || 0) / 60);
                    document.getElementById('stat-logins').textContent = stats.total_logins || 0;
                    document.getElementById('stat-warnings').textContent = stats.warnings_count || 0;
                    document.getElementById('stat-achievements').textContent = stats.achievements_count || 0;
                    
                    // Discord статус
                    const discordInfo = document.getElementById('discord-info');
                    const discordBtn = document.getElementById('discord-connect-btn');
                    if (data.discord) {
                        discordInfo.textContent = data.discord;
                        discordBtn.innerHTML = '<i class="fab fa-discord mr-1"></i>Отвязать Discord';
                        discordBtn.className = discordBtn.className.replace('from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700', 'from-red-600 to-red-600 hover:from-red-700 hover:to-red-700');
                    } else {
                        discordInfo.textContent = 'Не привязан';
                        discordBtn.innerHTML = '<i class="fab fa-discord mr-1"></i>Привязать Discord';
                        discordBtn.className = discordBtn.className.replace('from-red-600 to-red-600 hover:from-red-700 hover:to-red-700', 'from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700');
                    }
                    
                    // Email статус
                    const emailStatus = document.getElementById('email-status');
                    const verifyBtn = document.getElementById('verify-email-btn');
                    if (data.is_email_verified) {
                        emailStatus.textContent = '✅ Email подтвержден';
                        emailStatus.className = 'text-green-400';
                        verifyBtn.classList.add('hidden');
                    } else {
                        emailStatus.textContent = '❌ Email не подтвержден';
                        emailStatus.className = 'text-red-400';
                        verifyBtn.classList.remove('hidden');
                    }
                    
                    // Показываем кнопку админ панели для уровня доверия 5 или роли админа
                    const adminLink = document.getElementById('admin-link');
                    if ((data.trust_level >= 5) || (data.role === 'admin' || data.role === 'moderator')) {
                        adminLink.classList.remove('hidden');
                    } else {
                        adminLink.classList.add('hidden');
                    }
                    
                    // Статус пользователя
                    const statusElement = document.getElementById('user-status');
                    const status = data.status || 'active'; // Получаем статус из данных
                    
                    switch(status) {
                        case 'banned':
                            statusElement.textContent = 'ЗАБАНЕН';
                            statusElement.className = 'font-bold text-lg text-red-400';
                            break;
                        case 'pending':
                            statusElement.textContent = 'На проверке';
                            statusElement.className = 'font-bold text-lg text-yellow-400';
                            break;
                        case 'rejected':
                            statusElement.textContent = 'Не принят';
                            statusElement.className = 'font-bold text-lg text-orange-400';
                            break;
                        case 'active':
                        default:
                            statusElement.textContent = 'Активен';
                            statusElement.className = 'font-bold text-lg text-green-400';
                            break;
                    }
                    
                    // Альтернативный способ проверки через is_banned для совместимости
                    if (data.is_banned) {
                        statusElement.textContent = 'ЗАБАНЕН';
                        statusElement.className = 'font-bold text-lg text-red-400';
                    }
                } else {
                    console.error('Ошибка загрузки профиля');
                }
            } catch (error) {
                console.error('Ошибка загрузки данных профиля:', error);
            }
        }

        function getTrustLevelPrivileges(level) {
            const privileges = {
                0: 'Базовые права пользователя, лимит игрового времени',
                1: 'Неограниченное время игры, доступ к форуму',
                2: 'Участие в голосованиях, система репутации',
                3: 'Создание ивентов, приглашение друзей, наставничество',
                4: 'Модерация заявок, управление ивентами, просмотр логов',
                5: 'Полные административные права'
            };
            return privileges[level] || 'Неизвестный уровень';
        }

        async function loadActivity() {
            const token = localStorage.getItem('auth_token');
            const activityList = document.getElementById('activity-list');
            
            try {
                const response = await fetch('/api/profile/activity', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.activity && data.activity.length > 0) {
                        activityList.innerHTML = data.activity.map(activity => `
                            <div class="flex items-center p-4 bg-minecraft-dark rounded-lg border border-minecraft-light-gray">
                                <div class="w-2 h-2 bg-minecraft-gold rounded-full mr-4"></div>
                                <div class="flex-1">
                                    <div class="text-white font-medium">${activity.description}</div>
                                    <div class="text-sm text-gray-400">${new Date(activity.created_at).toLocaleString('ru-RU')}</div>
                                </div>
                                <div class="text-minecraft-gold text-sm font-medium">
                                    ${activity.activity_type}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        activityList.innerHTML = `
                            <div class="text-center text-gray-400 py-12">
                                <i class="fas fa-history text-4xl mb-4"></i>
                                <p class="text-lg">Нет записей активности</p>
                            </div>
                        `;
                    }
                } else {
                    activityList.innerHTML = `
                        <div class="text-center text-red-400 py-12">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p class="text-lg">Ошибка загрузки активности</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Ошибка загрузки активности:', error);
                activityList.innerHTML = `
                    <div class="text-center text-red-400 py-12">
                        <i class="fas fa-wifi text-4xl mb-4"></i>
                        <p class="text-lg">Ошибка соединения</p>
                    </div>
                `;
            }
        }

        async function loadStatistics() {
            // Дополнительная загрузка статистики уже происходит в loadProfileData
            // Здесь можно добавить загрузку графиков и достижений
            
            const achievementsContainer = document.getElementById('recent-achievements');
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/profile/achievements', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.achievements && data.achievements.length > 0) {
                        achievementsContainer.innerHTML = data.achievements.slice(0, 5).map(achievement => `
                            <div class="flex items-center p-3 bg-minecraft-dark rounded-lg">
                                <i class="fas fa-trophy text-minecraft-gold mr-3"></i>
                                <div>
                                    <div class="font-medium text-white">${achievement.name}</div>
                                    <div class="text-sm text-gray-400">${achievement.description}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        achievementsContainer.innerHTML = `
                            <div class="text-center text-gray-400 py-8">
                                <i class="fas fa-trophy text-2xl mb-2"></i>
                                <p>Пока нет достижений</p>
                            </div>
                        `;
                    }
                } else {
                    achievementsContainer.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-trophy text-2xl mb-2"></i>
                            <p>Ошибка загрузки достижений</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Ошибка загрузки достижений:', error);
            }
        }

        function showMessage(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `mb-6 p-4 rounded-lg ${
                type === 'success' ? 
                'bg-green-900 text-green-300 border border-green-700' : 
                'bg-red-900 text-red-300 border border-red-700'
            }`;
            element.classList.remove('hidden');
            
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
