# Chiwawa Server Backend

Многостраничная система управления сервером с PostgreSQL интеграцией.

## Архитектура

### Новая структура (v2.0)
- **Многостраничная архитектура**: отдельные страницы /profile и /admin
- **PostgreSQL база данных**: полная интеграция с 15+ таблицами
- **JWT авторизация**: сессии с токенами и ролевая система
- **Trust Level система**: уровни доверия 0-5 с прогрессом
- **API маршруты**: RESTful API для всех операций

### Структура файлов
```
backend/
├── server.js              # Главный сервер
├── routes/                 # API маршруты
│   ├── auth.js            # Авторизация и аутентификация
│   ├── profile.js         # Управление профилем
│   ├── applications.js    # Заявки на whitelist
│   └── admin.js           # Админ-панель
├── database/              # База данных
│   ├── connection.js      # Подключение к PostgreSQL
│   └── schema.sql         # Схема БД (15 таблиц)
└── package.json           # Зависимости
```

## Установка

1. **Установка зависимостей:**
   ```bash
   npm install
   ```

2. **Настройка базы данных:**
   ```bash
   # Локальная разработка
   npm run setup-db
   
   # Продакшен VPS
   npm run setup-db-vps
   ```

3. **Конфигурация:**
   ```bash
   cp .env.example .env
   # Отредактируйте .env файл
   ```

## Запуск

### Разработка
```bash
npm run dev
```

### Продакшен
```bash
npm start
```

## API Endpoints

### Авторизация (`/api/auth`)
- `POST /api/auth/login` - Вход в систему
- `POST /api/auth/logout` - Выход из системы
- `GET /api/auth/verify` - Проверка токена
- `GET /api/auth/profile` - Профиль пользователя

### Профиль (`/api/profile`)
- `GET /api/profile` - Получение данных профиля
- `PUT /api/profile` - Обновление профиля
- `POST /api/profile/verify-email` - Подтверждение email
- `GET /api/profile/activity` - История активности

### Заявки (`/api/applications`)
- `POST /api/applications` - Подача заявки
- `GET /api/applications/status/:email` - Статус заявки
- `GET /api/applications` - Все заявки (админ)
- `PUT /api/applications/:id/review` - Рассмотрение заявки (админ)

### Админ-панель (`/api/admin`)
- `GET /api/admin/users` - Управление пользователями
- `PUT /api/admin/users/:id/ban` - Блокировка пользователя
- `PUT /api/admin/users/:id/trust-level` - Изменение Trust Level
- `GET /api/admin/stats` - Статистика системы
- `GET /api/admin/logs` - Логи действий

## База данных

### PostgreSQL схема
- **users** - Пользователи системы
- **applications** - Заявки на whitelist
- **user_sessions** - Активные сессии
- **trust_level_progress** - Прогресс Trust Level
- **action_logs** - Логи всех действий
- **admins** - Роли администраторов
- **achievements** - Система достижений
- И другие...

### Подключение
Автоматическое определение хоста:
- `localhost` для разработки
- `212.15.49.139` для продакшена

### Учетные данные
- **Host**: localhost/212.15.49.139
- **User**: chiwawa
- **Password**: mtU-PSM-cFP-2D6
- **Database**: chiwawa

## Trust Level System

### Уровни доверия (0-5)
- **0**: Новичок (ограниченные права)
- **1**: Проверенный игрок
- **2**: Постоянный игрок
- **3**: Доверенный игрок
- **4**: Уважаемый игрок
- **5**: Легенда сообщества

### Прогресс
- Email подтверждение: +10 очков
- Discord связка: +15 очков
- Игровое время: +1 очко за час
- Голосование: +5 очков за голос
- Репутация от игроков

## Безопасность

### Защита
- **Helmet.js**: Заголовки безопасности
- **Rate Limiting**: Лимиты запросов
- **CORS**: Настроенные домены
- **JWT**: Токены с истечением
- **bcryptjs**: Хеширование паролей

### Логирование
Все действия пользователей логируются в таблицу `action_logs`:
- Вход/выход
- Изменения профиля
- Административные действия
- Подача заявок

## Страницы

### Главная (/)
- Информация о сервере
- Форма подачи заявки
- Статус сервера

### Профиль (/profile)
- Личные данные пользователя
- Trust Level прогресс
- История активности
- Настройки аккаунта

### Админ-панель (/admin)
- Управление пользователями
- Рассмотрение заявок
- Статистика системы
- Системные логи

*Создатель: ebluffy*

### GET /api/applications
Просмотр всех поданных заявок.

## Установка и запуск

```bash
cd backend
npm install
npm start
```

## Логирование

Заявки сохраняются в файл `applications.log`.